<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Generate Resume ‚Äì SkillsDoc</title>
  <link rel="icon" href="/favicon.png" type="image/png"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-[#f3e8ff] min-h-screen text-gray-800">

  <header class="bg-gradient-to-r from-purple-200 via-purple-400 to-purple-100 shadow px-4 py-2 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <h1 class="text-xl font-bold text-gray-800">üé® Resume Generator</h1>
      <a href="resume.html"
         class="inline-block px-4 py-2 text-sm font-medium bg-purple-100 text-purple-700 rounded hover:bg-purple-200 transition-all">
        ‚Üê Back to Templates
      </a>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-10">
    <section class="bg-white shadow-md rounded-xl p-8 text-gray-900 max-w-3xl mx-auto">
      <div class="flex justify-between items-start mb-6">
        <div>
          <h1 class="text-3xl font-bold text-purple-800" id="resumeName">Student Name</h1>
          <p class="text-sm text-gray-600" id="resumeTitle">Course Title</p>
          <p class="text-sm text-gray-600" id="resumeCollege">College Name (Duration)</p>
          <p class="text-sm text-gray-500" id="resumeContact">üìß email@example.com</p>
        </div>

        <div class="relative group w-24 h-28 border border-gray-300 shadow-sm bg-gray-100 rounded overflow-hidden">
         <img id="resumePhoto"
             src="https://ui-avatars.com/api/?name=User"
             crossorigin="anonymous"
             alt="Profile"
             class="w-full h-full object-cover rounded"
             onerror="this.src='https://ui-avatars.com/api/?name=User';" />
        </div>
      </div>

      <div class="mb-6 relative group">
        <h2 class="text-xl font-semibold text-purple-700 flex items-center gap-2">
            Professional Summary 
            <span class="text-xs bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full border border-purple-200">AI Powered</span>
        </h2>
        <p class="text-sm mt-1 p-2 rounded hover:bg-gray-50 transition" id="resumeSummary">
          Click "‚ú® AI Generate Summary" below to create a professional summary based on your uploaded skills.
        </p>
      </div>

      <div class="mb-6">
        <h2 class="text-xl font-semibold text-purple-700">Skills</h2>
        <ul class="list-disc list-inside text-sm mt-1" id="resumeSkills">
          <li>Loading skills...</li>
        </ul>
      </div>

      <div class="mb-6">
        <h2 class="text-xl font-semibold text-purple-700">Projects</h2>
        <ul class="text-sm mt-1" id="resumeProjects">
          <li><strong>Project Portfolio</strong> ‚Äì See attached skills for verified project certificates.</li>
        </ul>
      </div>

      <div class="flex flex-wrap gap-3 mt-6 border-t pt-6">
        <button onclick="generateAIContent()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded shadow flex items-center gap-2">
            ‚ú® AI Generate Summary
        </button>
        <button onclick="analyzeResumeATS()" class="bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded shadow flex items-center gap-2">
            üìä Check ATS Score
        </button>

        <button onclick="downloadResumePDF()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow ml-auto">
            üìÑ Download PDF
        </button>
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

    // 1. YOUR NEW FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCn3sLUtlC2q0EXguvQr7HS3ocol4k-Gtg",
      authDomain: "resume-ai-6c8ce.firebaseapp.com",
      projectId: "resume-ai-6c8ce",
      storageBucket: "resume-ai-6c8ce.firebasestorage.app",
      messagingSenderId: "80667329410",
      appId: "1:80667329410:web:00d0783305e073a9e0c59b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
// 2. YOUR GEMINI API KEY
const GEMINI_API_KEY = "AIzaSyBh9jjG6PZzSKJxUgKnpjm0df-lIVboVX0";

    let currentUserData = null;
    let currentSkills = [];

    // Load Data on Startup
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        window.currentUid = user.uid;
        
        // Fetch Profile
        const docSnap = await getDoc(doc(db, "users", user.uid));
        if (docSnap.exists()) {
          currentUserData = docSnap.data();
          updateUI(currentUserData);
        }

        // Fetch Skills
        const q = query(collection(db, "skills"), where("uid", "==", user.uid));
        const skillSnap = await getDocs(q);
        const skillsList = document.getElementById("resumeSkills");
        skillsList.innerHTML = "";
        
        if (!skillSnap.empty) {
            skillSnap.forEach(doc => {
            const s = doc.data();
            currentSkills.push(`${s.title}`);
            const li = document.createElement("li");
            li.textContent = s.title;
            skillsList.appendChild(li);
            });
        } else {
            skillsList.innerHTML = "<li>No skills added yet.</li>";
        }

      } else {
        // Redirect to login if not logged in
        window.location.href = "login.html";
      }
    });

    function updateUI(data) {
        if(data.displayName) document.getElementById("resumeName").innerText = data.displayName;
        if(data.course) document.getElementById("resumeTitle").innerText = data.course;
        if(data.college) document.getElementById("resumeCollege").innerText = `${data.college} (${data.duration || ''})`;
        if(data.email) document.getElementById("resumeContact").innerText = `üìß ${data.email}`;
        if(data.photoURL) document.getElementById("resumePhoto").src = data.photoURL;
    }

    // ---------------------------------------------------------
    // ü§ñ AI FEATURE 1: Generate Summary
    // ---------------------------------------------------------
    window.generateAIContent = async function() {
        if (!currentUserData) return alert("User data not loaded yet.");

        const summaryBox = document.getElementById("resumeSummary");
        const originalText = summaryBox.innerText;
        summaryBox.innerHTML = "<i>‚ú® Gemini is writing your summary...</i>";
        summaryBox.classList.add("animate-pulse");

        const prompt = `
            You are an expert resume writer. 
            Student Profile: ${currentUserData.displayName}, ${currentUserData.course}.
            Skills List: ${currentSkills.join(", ")}.
            
            Task: Write a professional, punchy resume summary (max 35 words) for this student. 
            Focus on their skills and potential.
            Do not use markdown formatting. Just plain text.
        `;

        try {
            const text = await callGemini(prompt);
            summaryBox.classList.remove("animate-pulse");
            summaryBox.innerText = text;
        } catch (e) {
            console.error(e);
            alert("AI Error: " + e.message);
            summaryBox.innerText = originalText;
            summaryBox.classList.remove("animate-pulse");
        }
    }

    // ---------------------------------------------------------
    // üìä AI FEATURE 2: ATS Analyzer
    // ---------------------------------------------------------
    window.analyzeResumeATS = async function() {
        const summaryText = document.getElementById("resumeSummary").innerText;
        if (summaryText.includes("Gemini is writing") || summaryText.includes("Click")) {
            return alert("Please generate a summary first!");
        }

        alert("üîç Analyzing your resume against ATS standards...");

        const prompt = `
            Act as an Applicant Tracking System (ATS) scanner.
            Analyze this candidate profile:
            Role: ${currentUserData.course}
            Skills: ${currentSkills.join(", ")}
            Summary: "${summaryText}"

            Output ONLY valid JSON like this:
            {
                "score": 85,
                "missing_keywords": ["Keyword1", "Keyword2"],
                "verdict": "One short sentence verdict."
            }
        `;

        try {
            const text = await callGemini(prompt);
            // Clean markdown if Gemini adds it
            const jsonStr = text.replace(/```json/g, "").replace(/```/g, "").trim();
            const data = JSON.parse(jsonStr);

            alert(`üìä ATS Score: ${data.score}/100\n\nüí° Verdict: ${data.verdict}\n\n‚ö†Ô∏è Missing Keywords: ${data.missing_keywords.join(", ")}`);
        } catch (e) {
            console.error(e);
            alert("Analysis failed. Try again.");
        }
    }

    // üîå Helper: Call Gemini API
    async function callGemini(promptText) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ contents: [{ parts: [{ text: promptText }] }] })
        });
        
        if (!response.ok) throw new Error("Gemini API Error: " + response.statusText);

        const data = await response.json();
        return data.candidates[0].content.parts[0].text;
    }

    // PDF Download Logic
    window.downloadResumePDF = function() {
        const element = document.querySelector("section");
        const opt = {
          margin:       0.5,
          filename:     'SkillsDoc_Resume.pdf',
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2 },
          jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>